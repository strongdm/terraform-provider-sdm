// Code generated by protogen. DO NOT EDIT.

package sdm

import (
	"context"
	"crypto/sha1"
	"encoding/base64"
	"encoding/hex"
	"encoding/json"
	"strings"

	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
)

func resourceManagedSecretValue() *schema.Resource {
	return &schema.Resource{
		ReadContext:        nilCrudFunc,
		CreateContext:      managedSecretValueCreate,
		DeleteContext:      nilCrudFunc,
		DeprecationMessage: "sdm_managed_secret_value is deprecated. Set sdm_managed_secret resource's value directly with base64 encoded json value.",
		Schema: map[string]*schema.Schema{
			"value": {
				Description: "value object",
				Type:        schema.TypeMap,
				Required:    true,
				ForceNew:    true,
				Elem: &schema.Schema{
					Type: schema.TypeString,
				},
			},
			"public_key": {
				Description: "secret engine's public key used for encryption in PEM format",
				Type:        schema.TypeString,
				Required:    true,
				ForceNew:    true,
			},
			"encrypted": {
				Description: "encrypted value",
				Type:        schema.TypeString,
				Computed:    true,
			},
		},
	}
}

func nilCrudFunc(_ context.Context, _ *schema.ResourceData, _ any) diag.Diagnostics {
	return nil
}

func managedSecretValueCreate(ctx context.Context, d *schema.ResourceData, meta any) diag.Diagnostics {
	value := d.Get("value")

	payload, err := json.Marshal(value)
	if err != nil {
		return diag.Errorf("failed to marshal value to json: %s", err)
	}

	d.Set("encrypted", base64.StdEncoding.EncodeToString(payload))
	d.SetId(hashForValue(string(payload)))
	return nil
}

func hashForValue(value string) string {
	if len(value) == 0 {
		return ""
	}
	hash := sha1.Sum([]byte(strings.TrimSpace(value)))
	return hex.EncodeToString(hash[:])
}

// register new resource type
func init() {
	resourcesMap["sdm_managed_secret_value"] = resourceManagedSecretValue
}
