// Code generated by protogen. DO NOT EDIT.
// See pkg/api/v1/templates/terraform-provider-sdm/sdm/*_test.go.tpl

package sdm

import (
	"context"
	"fmt"
	"testing"
	"time"

	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/resource"
	"github.com/hashicorp/terraform-plugin-sdk/v2/terraform"
	sdm "github.com/strongdm/terraform-provider-sdm/sdm/internal/sdk"
)

func init() {
	resource.AddTestSweepers("sdm_connector", &resource.Sweeper{
		Name: "sdm_connector",
		F: func(region string) error {
			client, err := preTestClient()
			if err != nil {
				return fmt.Errorf("Error getting client: %s", err)
			}

			ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
			defer cancel()
			listResp, err := client.DiscoveryConnectors().List(ctx, "name:*-test-acc")
			if err != nil {
				return fmt.Errorf("Error listing connectors: %s", err)
			}
			for listResp.Next() {
				v := listResp.Value()
				_, err := client.DiscoveryConnectors().Delete(ctx, v.GetID())
				if err != nil {
					fmt.Printf("error deleting connector %s %s\n", v.GetID(), err)
				}
			}
			if listResp.Err() != nil {
				return fmt.Errorf("error after listing connectors %s", listResp.Err())
			}
			return nil
		},
	})
}

func TestAccSDMConnector_CreateAWS(t *testing.T) {
	initAcceptanceTest(t)
	rsName := randomWithPrefix("test-connector-resource")
	connectorName := randomWithPrefix("test-connector")
	resource.ParallelTest(t, resource.TestCase{
		Providers:    testAccProviders,
		CheckDestroy: testCheckDestroy,
		Steps: []resource.TestStep{
			{
				Config: testAccSDMAWSConnectorConfig(rsName, connectorName),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "aws.0.name", connectorName),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "aws.0.scan_period", "Daily"),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "aws.0.role_name", "test-role"),
					func(s *terraform.State) error {
						id, err := testCreatedID(s, "sdm_connector", rsName)
						if err != nil {
							return err
						}

						client := testClient()
						ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
						defer cancel()
						resp, err := client.DiscoveryConnectors().Get(ctx, id)
						if err != nil {
							return fmt.Errorf("failed to get created resource: %w", err)
						}

						aws, ok := resp.Connector.(*sdm.AWSConnector)
						if !ok {
							return fmt.Errorf("expected AWSConnector, got %T", resp.Connector)
						}
						if aws.Name != connectorName {
							return fmt.Errorf("unexpected name '%s', expected '%s'", aws.Name, connectorName)
						}

						return nil
					},
				),
			},
			{
				ResourceName:      "sdm_connector." + rsName,
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

func TestAccSDMConnector_CreateAzure(t *testing.T) {
	initAcceptanceTest(t)
	rsName := randomWithPrefix("test-connector-resource")
	connectorName := randomWithPrefix("test-connector")
	resource.ParallelTest(t, resource.TestCase{
		Providers:    testAccProviders,
		CheckDestroy: testCheckDestroy,
		Steps: []resource.TestStep{
			{
				Config: testAccSDMAzureConnectorConfig(rsName, connectorName),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "azure.0.name", connectorName),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "azure.0.scan_period", "TwiceDaily"),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "azure.0.tenant_id", "tenant-123"),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "azure.0.client_id", "client-456"),
				),
			},
			{
				ResourceName:      "sdm_connector." + rsName,
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

func TestAccSDMConnector_CreateGCP(t *testing.T) {
	initAcceptanceTest(t)
	rsName := randomWithPrefix("test-connector-resource")
	connectorName := randomWithPrefix("test-connector")
	resource.ParallelTest(t, resource.TestCase{
		Providers:    testAccProviders,
		CheckDestroy: testCheckDestroy,
		Steps: []resource.TestStep{
			{
				Config: testAccSDMGCPConnectorConfig(rsName, connectorName),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "gcp.0.name", connectorName),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "gcp.0.scan_period", "Daily"),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "gcp.0.project_number", "123456789"),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "gcp.0.provider_id", "provider-123"),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "gcp.0.pool_id", "pool-456"),
				),
			},
			{
				ResourceName:      "sdm_connector." + rsName,
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

func TestAccSDMConnector_Update(t *testing.T) {
	initAcceptanceTest(t)
	rsName := randomWithPrefix("test-connector")
	connectorName := randomWithPrefix("test-connector")
	updatedConnectorName := randomWithPrefix("test-connector-updated")
	resource.ParallelTest(t, resource.TestCase{
		Providers:    testAccProviders,
		CheckDestroy: testCheckDestroy,
		Steps: []resource.TestStep{
			{
				Config: testAccSDMAWSConnectorConfig(rsName, connectorName),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "aws.0.name", connectorName),
				),
			},
			{
				Config: testAccSDMAWSConnectorConfigUpdated(rsName, updatedConnectorName),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "aws.0.name", updatedConnectorName),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "aws.0.description", "Updated description"),
					resource.TestCheckResourceAttr("sdm_connector."+rsName, "aws.0.scan_period", "TwiceDaily"),
					func(s *terraform.State) error {
						id, err := testCreatedID(s, "sdm_connector", rsName)
						if err != nil {
							return err
						}

						client := testClient()
						ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
						defer cancel()
						resp, err := client.DiscoveryConnectors().Get(ctx, id)
						if err != nil {
							return fmt.Errorf("failed to get updated resource: %w", err)
						}

						aws, ok := resp.Connector.(*sdm.AWSConnector)
						if !ok {
							return fmt.Errorf("expected AWSConnector, got %T", resp.Connector)
						}
						if aws.Name != updatedConnectorName {
							return fmt.Errorf("unexpected name '%s', expected '%s'", aws.Name, updatedConnectorName)
						}

						return nil
					},
				),
			},
			{
				ResourceName:      "sdm_connector." + rsName,
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

func testAccSDMAWSConnectorConfig(resourceName string, connectorName string) string {
	return fmt.Sprintf(`
	resource "sdm_connector" "%s" {
		aws {
			name = "%s"
			scan_period = "Daily"
			role_name = "test-role"
			account_ids = ["123456789012"]
		}
	}`, resourceName, connectorName)
}

func testAccSDMAWSConnectorConfigUpdated(resourceName string, connectorName string) string {
	return fmt.Sprintf(`
	resource "sdm_connector" "%s" {
		aws {
			name = "%s"
			description = "Updated description"
			scan_period = "TwiceDaily"
			role_name = "test-role"
			account_ids = ["123456789012"]
			services = ["RDS", "EC2"]
		}
	}`, resourceName, connectorName)
}

func testAccSDMAzureConnectorConfig(resourceName string, connectorName string) string {
	return fmt.Sprintf(`
	resource "sdm_connector" "%s" {
		azure {
			name = "%s"
			scan_period = "TwiceDaily"
			tenant_id = "tenant-123"
			client_id = "client-456"
			subscription_ids = ["sub-1", "sub-2"]
		}
	}`, resourceName, connectorName)
}

func testAccSDMGCPConnectorConfig(resourceName string, connectorName string) string {
	return fmt.Sprintf(`
	resource "sdm_connector" "%s" {
		gcp {
			name = "%s"
			scan_period = "Daily"
			project_number = "123456789"
			provider_id = "provider-123"
			pool_id = "pool-456"
			project_ids = ["project-1", "project-2"]
		}
	}`, resourceName, connectorName)
}

func createConnectorsWithPrefix(prefix string, count int) ([]sdm.Connector, error) {
	client, err := preTestClient()
	if err != nil {
		return nil, fmt.Errorf("failed to create test client: %w", err)
	}
	ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
	defer cancel()
	connectors := []sdm.Connector{}
	for i := 0; i < count; i++ {
		createResp, err := client.DiscoveryConnectors().Create(ctx, &sdm.AWSConnector{
			Name:       randomWithPrefix(prefix),
			ScanPeriod: "Daily",
			RoleName:   "test-role",
			AccountIDs: []string{"123456789012"},
		})
		if err != nil {
			return nil, fmt.Errorf("failed to create connector: %w", err)
		}
		connectors = append(connectors, createResp.Connector)
	}
	return connectors, nil
}
